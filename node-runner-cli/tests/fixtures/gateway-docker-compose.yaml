version: '3.8'
services:
  gateway_api: # This is the base -- the _image and _built containers are defined below
    image: radixdlt/babylon-ng-gateway-api:rcnet-v2-phase2-r4
    ports:
      - "127.0.0.1:5207:80" # This allows you to connect to the API at http://localhost:5308
      - "127.0.0.1:1235:1235" # This allows you to connect to the metrics API at http://localhost:1235
    restart: unless-stopped
    extra_hosts:
    - "host.docker.internal:host-gateway"
    environment:
      ASPNETCORE_URLS: "http://*:80" # Binds to 80 on all interfaces
      PrometheusMetricsPort: "1235"
      EnableSwagger: "true"
      ConnectionStrings__NetworkGatewayReadOnly: "Host=host.docker.internal:5432;Database=radixdlt_ledger;Username=postgres;Password=postgres"
      ConnectionStrings__NetworkGatewayReadWrite: "Host=host.docker.internal:5432;Database=radixdlt_ledger;Username=postgres;Password=postgres"
      GatewayApi__Endpoints_MaxPageSize: "30"
      GatewayApi__Endpoint__GatewayApiVersion: rcnet-v2-phase2-r4
      # GatewayApi__MaxWaitForDbOnStartupMs: "90" # Wait for PostGres to boot up
      GatewayApi__Network__DisableCoreApiHttpsCertificateChecks: "true"
      GatewayApi__Network__NetworkName: "ansharnet"
      GatewayApi__Network__CoreApiNodes__0__Name: "CoreNode"
      GatewayApi__Network__CoreApiNodes__0__CoreApiAddress: "https://host.docker.internal:443/core"
      GatewayApi__Network__CoreApiNodes__0__CoreApiAuthorizationHeader: "Basic YWRtaW46cmFkaXg="
      GatewayApi__Network__CoreApiNodes__0__RequestWeighting: "1"
      GatewayApi__Network__CoreApiNodes__0__Enabled: "true"
  data_aggregator:
    depends_on:
      - database_migrations
    image: radixdlt/babylon-ng-data-aggregator:rcnet-v2-phase2-r4
    restart: unless-stopped
    cpus: 2.0
    extra_hosts:
    - "host.docker.internal:host-gateway"
    ports:
      - "127.0.0.1:5208:80" # This allows you to connect to the API (for root and health checks) at http://localhost:5207
      - "127.0.0.1:1234:1234" # This allows you to connect to the metrics API at http://localhost:1234
    environment:
      # WIPE_DATABASE: "true"
      ASPNETCORE_URLS: "http://*:80" # Binds to 80 on all interfaces
      ConnectionStrings__NetworkGatewayReadWrite: "Host=host.docker.internal:5432;Database=radixdlt_ledger;Username=postgres;Password=postgres"
      PrometheusMetricsPort: "1234"
      DataAggregator__Network__MaxWaitForDbOnStartupMs: "1000"
      DataAggregator__Network__DisableCoreApiHttpsCertificateChecks: "true"
      DataAggregator__Network__NetworkName: "ansharnet"
      DataAggregator__Network__CoreApiNodes__0__Name: "CoreNode"
      DataAggregator__Network__CoreApiNodes__0__CoreApiAddress: "https://host.docker.internal:443/core"
      DataAggregator__Network__CoreApiNodes__0__CoreApiAuthorizationHeader: "Basic YWRtaW46cmFkaXg="
      DataAggregator__Network__CoreApiNodes__0__TrustWeighting: "1"
      DataAggregator__Network__CoreApiNodes__0__Enabled: "true"
  database_migrations: # This is the base -- the _image and _built containers are defined below
    image: radixdlt/babylon-ng-database-migrations:rcnet-v2-phase2-r4
    environment:
      ConnectionStrings__NetworkGatewayMigrations: Host=host.docker.internal:5432;Database=radixdlt_ledger;Username=postgres;Password=postgres
    extra_hosts:
    - "host.docker.internal:host-gateway"
