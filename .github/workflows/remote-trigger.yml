name: Test Babylon-Nginx

on:
  repository_dispatch:
    types: [trigger-workflow]
    
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: RDXWorks-actions/checkout@main

  test-userflow-docker-core-gateway-same-host:
    runs-on: gh-ephemeral-nodecli-docker-runner
    steps:
      - name: Checkout
        uses: RDXWorks-actions/checkout@main
        with:
          fetch-depth: 0
      - name: Download packaged cli
        run: |
          wget -O babylonnode https://github.com/radixdlt/babylon-nodecli/releases/download/2.1.1/babylonnode-ubuntu-22.04
          chmod +x babylonnode
      - name: Get dependencies
        run: |
          chmod +x ./babylonnode
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq docker-compose
          ./babylonnode docker dependencies
      - name: "Execute User Flow: Install Core, Gateway and Monitoring on the same host"
        run: |
          chmod +x  ./node-runner-cli/tests/userflows/install-docker-all-same-host.sh
          ./node-runner-cli/tests/userflows/install-docker-all-same-host.sh
        env:
          NGINX_ADMIN_PASSWORD: ${{secrets.NGINX_ADMIN_PASSWORD}}
          NGINX_METRICS_PASSWORD: ${{secrets.NGINX_METRICS_PASSWORD}}
          NGINX_GATEWAY_PASSWORD: ${{secrets.NGINX_GATEWAY_PASSWORD}}
          POSTGRES_PASSWORD: ${{secrets.POSTGRES_PASSWORD}}
          KEYSTORE_PASSWORD: ${{secrets.KEYSTORE_PASSWORD}}
          SEED_NODE: ${{ vars.SEED_NODE }}
          NETWORK_ID: ${{ vars.NETWORK_ID }}
          NETWORK_NAME: ${{ vars.NETWORK_NAME }}
          RADIXDLT_NGINX_VERSION_OVERRIDE: 1.0.5-rc1
          NGINX_BINARY_OVERIDE: "https://github.com/radixdlt/babylon-nginx/releases/download/1.0.5-rc1/babylon-nginx-fullnode-conf.zip"

  test-userflow-systemd-simple:
    runs-on: gh-ephemeral-nodecli-systemd-runner
    steps:
      - name: Checkout
        uses: RDXWorks-actions/checkout@main
        with:
          fetch-depth: 0
      - name: Download packaged cli
        run: |
          wget -O babylonnode https://github.com/radixdlt/babylon-nodecli/releases/download/2.1.1/babylonnode-ubuntu-22.04
          chmod +x babylonnode
      - name: Get dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          chmod +x ./babylonnode
      #          Expect dependencies to be installed before. Since the command is interactive
      #          ./babylonnode systemd dependencies
      - name: "Execute User Flow: Install Core, Gateway and Monitoring on the same host"
        run: |
          export DOCKER_COMPOSE_LOCATION="/usr/local/bin/docker-compose"
          chmod +x  ./node-runner-cli/tests/userflows/install-systemd-simple.sh
          ./node-runner-cli/tests/userflows/install-systemd-simple.sh
        env:
          NGINX_ADMIN_PASSWORD: ${{secrets.NGINX_ADMIN_PASSWORD}}
          NGINX_METRICS_PASSWORD: ${{secrets.NGINX_METRICS_PASSWORD}}
          NGINX_GATEWAY_PASSWORD: ${{secrets.NGINX_GATEWAY_PASSWORD}}
          POSTGRES_PASSWORD: ${{secrets.POSTGRES_PASSWORD}}
          KEYSTORE_PASSWORD: ${{secrets.KEYSTORE_PASSWORD}}
          SEED_NODE: ${{ vars.SEED_NODE }}
          NETWORK_ID: ${{ vars.NETWORK_ID }}
          NETWORK_NAME: ${{ vars.NETWORK_NAME }}
          RADIXDLT_NGINX_VERSION_OVERRIDE: 1.0.5-rc1
          NGINX_BINARY_OVERIDE: "https://github.com/radixdlt/babylon-nginx/releases/download/1.0.5-rc1/babylon-nginx-fullnode-conf.zip"
    
    