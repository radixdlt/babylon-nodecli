name: Build and Push Docker Image

# Trigger the workflow on releases and file changes
on:
  release:
    types: [published]
  push:
    paths:
      - Dockerfile.ledgerdownloader
      - downloadLedgerSnapshot.sh

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout
        uses: RDXWorks-actions/checkout@main
        with:
          fetch-depth: 0

      - name: "Configure AWS credentials (Private)"
        uses: RDXWorks-actions/configure-aws-credentials@main
        with:
          role-to-assume: arn:aws:iam::${{ secrets.SECRETS_ACCOUNT_ID }}:role/gh-common-secrets-read-access
          aws-region: eu-west-2
      # This is version v1.0.4
      # https://github.com/aws-actions/configure-aws-credentials/releases/tag/v1.0.4
      - name: Read secrets from AWS Secrets Manager into environment variables (Private)
        uses: RDXWorks-actions/aws-secretsmanager-get-secrets@main
        with:
          secret-ids: |
            DOCKERHUB_PRIVATE, github-actions/common/dockerhub-credentials
          parse-json-secrets: true
      - name: Login to Docker Hub (Private)
        uses: RDXWorks-actions/login-action@master
        with:
          username: ${{env.DOCKERHUB_PRIVATE_USERNAME}}
          password: ${{env.DOCKERHUB_PRIVATE_TOKEN}}


      - name: Login to Dockerhub
        uses: RDXWorks-actions/login-action@master
        with:
          username: ${{ env.GH_USERNAME }}
          password: ${{ env.GH_TOKEN }}

      - name: Docker build and push
        uses: RDXWorks-actions/build-push-action@master
        with:
          file: ./Dockerfile.ledgerdownloader
          tags: radixdlt/radixdlt-download-latest-community-ledger-snapshot:latest
          push: true
          context: ./